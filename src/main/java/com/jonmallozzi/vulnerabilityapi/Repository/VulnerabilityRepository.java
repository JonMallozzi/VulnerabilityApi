package com.jonmallozzi.vulnerabilityapi.Repository;

import com.jonmallozzi.vulnerabilityapi.Model.Impact;
import com.jonmallozzi.vulnerabilityapi.Model.Vulnerability;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import java.util.HashMap;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Repository
public class VulnerabilityRepository implements IVulnerabilityRepository {
    private final HashMap<String, Vulnerability> vulnerabilities;

    public VulnerabilityRepository(HashMap<String, Vulnerability> vulnerabilities) {
        this.vulnerabilities = vulnerabilities;
    }

    @Override
    public HashMap<String, Vulnerability> findAll() {
        return this.vulnerabilities;
    }

    @Override
    public Vulnerability getById(String id) {
        return this.vulnerabilities.get(id);
    }
    @Override
    public Iterable<Vulnerability> getForSoftware(String software) {
        return this.vulnerabilities
                    .values()
                    .stream()
                    .filter(vulnerability -> vulnerability.getCve()
                                                            .getDescription()
                                                            .getDescription_data()
                                                            .get(0)
                                                            .getValue()
                                                            .toLowerCase()
                                                            .contains(software.toLowerCase()))
                    .collect(Collectors.toList());
    }

    @Override
    public Iterable<Vulnerability> getByV3Severity(String severity) {
        return this.vulnerabilities
                .values()
                .stream()
                .filter(vulnerability ->
                            Optional.ofNullable(
                                            vulnerability
                                    )
                                    .map(Vulnerability::getImpact)
                                    .map(Impact::getBaseMetricV3)
                                    .map(baseMetricV3 -> baseMetricV3.getCvssV3()
                                                                        .getBaseSeverity()
                                                                        .toLowerCase()
                                                                        .equals(severity))
                                    .orElse(false))
                .collect(Collectors.toList());
    }

    @Override
    public Iterable<Vulnerability> getByV2Severity(String severity) {
        return this.vulnerabilities
                .values()
                .stream()
                .filter(vulnerability ->
                        Optional.ofNullable(
                                        vulnerability
                                )
                                .map(Vulnerability::getImpact)
                                .map(Impact::getBaseMetricV2)
                                .map(baseMetricV2 -> baseMetricV2.getSeverity()
                                                                    .toLowerCase()
                                                                    .equals(severity))
                                .orElse(false))
                .collect(Collectors.toList());
    }

    @Override
    public Iterable<Vulnerability> getByV3AttackVector(String attackVector) {
        return this.vulnerabilities
                .values()
                .stream()
                .filter(vulnerability ->
                        Optional.ofNullable(
                                        vulnerability
                                )
                                .map(Vulnerability::getImpact)
                                .map(Impact::getBaseMetricV3)
                                .map(baseMetricV3 -> baseMetricV3.getCvssV3()
                                        .getAttackVector()
                                        .toLowerCase()
                                        .equals(attackVector))
                                .orElse(false))
                .collect(Collectors.toList());
    }

    @Override
    public Iterable<Vulnerability> getByV2AccessVector(String accessVector) {
        return this.vulnerabilities
                .values()
                .stream()
                .filter(vulnerability ->
                        Optional.ofNullable(
                                        vulnerability
                                )
                                .map(Vulnerability::getImpact)
                                .map(Impact::getBaseMetricV2)
                                .map(baseMetricV2 -> baseMetricV2.getCvssV2()
                                        .getAccessVector()
                                        .toLowerCase()
                                        .equals(accessVector))
                                .orElse(false))
                .collect(Collectors.toList());
    }

    @Override
    public void saveMultiple(List<Vulnerability> vulnerabilities) {
        vulnerabilities.forEach(vulnerability -> this.vulnerabilities.put(
                vulnerability
                        .getCve()
                        .getCVE_data_meta()
                        .getID(),
                        vulnerability
                ));
    }

    @Override
    public void save(Vulnerability vulnerability) {
        vulnerabilities.put(vulnerability.getCve().getCVE_data_meta().getID(), vulnerability);
    }

    @Override
    public void update(Vulnerability vulnerability) {
        vulnerabilities.replace(vulnerability.getCve().getCVE_data_meta().getID(), vulnerability);
    }

    @Override
    public void delete(String id) {
        vulnerabilities.remove(id);
    }
}
